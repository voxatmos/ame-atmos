// ==UserScript==
// @namespace   ame-musicbrainz-works
// @name        Ame (MusicBrainz - Works)
// @version     0.4.2
// @author      SuperSaltyGamer
// @run-at      document-end
// @match       https://musicbrainz.org/*
// @match       https://beta.musicbrainz.org/*
// @match       https://www.minc.or.jp/*
// @match       https://iswcnet.cisac.org/*
// @match       https://www2.jasrac.or.jp/*
// @grant       GM.addStyle
// @grant       GM.xmlHttpRequest
// @grant       GM.setValue
// @grant       GM.getValue
// @grant       GM.deleteValue
// @downloadURL https://gitlab.com/SuperSaltyGamer/ame/-/raw/main/dist/musicbrainz-works.user.js
// @updateURL https://gitlab.com/SuperSaltyGamer/ame/-/raw/main/dist/musicbrainz-works.user.js
// ==/UserScript==

(function(l){typeof define=="function"&&define.amd?define(l):l()})(function(){"use strict";function l(e){return new Promise(t=>{setTimeout(t,e)})}function H(e){const t=document.createElement("template");return t.innerHTML=e,t.content.firstElementChild}function k(e,t){return new Promise(o=>{{const i=document.querySelector(e);if(i){o(i);return}}const r=setTimeout(()=>{a.disconnect(),o(null)},3e3),a=new MutationObserver(i=>{for(const c of i)for(const s of Array.from(c.addedNodes))if(s instanceof Element&&s.matches(e)){a.disconnect(),clearTimeout(r),o(s);return}});a.observe(document.body,{childList:!0,subtree:!0})})}function _(e,t){new MutationObserver(async n=>{for(const r of n)for(const a of r.addedNodes){if(!(a instanceof HTMLElement))continue;const i=a.matches(e)?a:a.querySelector(e);i&&await t(i)}}).observe(document.body,{childList:!0,subtree:!0})}function h(e,t){return document.evaluate(t,e,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}function y(e,t){const o=document.evaluate(t,e,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);return Array.from({length:o.snapshotLength},(n,r)=>o.snapshotItem(r))}const w=new AudioContext,V=new Set(`[᠊᳓‾﹉-﹌_＿﹍-﹏︳︴‗-－﹣֊᐀᭠᠆᠇‐-–︲—﹘︱―⸺⸻⁓⹃⸗⹀⹝〜゠・･𐺭,，﹐︐⸴⸲⹁⹌⹎⹏՝،؍٫٬߸᠂᠈꓾꘍꛵𖺗、﹑︑､﹅﹆𖿢;;；﹔︔؛⁏⸵꛶⹉:：﹕︓⩴։؞܃-܈࠰-࠾፡፣-፦᠄᠅༔៖᭝꧇᛫-᛭꛴!！﹗︕¡⹓՜߹᥄𞥞?？﹖︖⁈⁇¿⸮⹔՞؟܉፧᥅⳺⳻꘏꛷꫱𑅃𞥟‽⸘.．․﹒‥︰…︙᠁۔܁܂።᠃᠉᙮᭜⳹⳾⸰⸼꓿꘎꛳𖫵𖺘𛲟。︒｡··⸱⸳।॥꣎꣏᰻᰼꡶꡷᜵᜶꤯၊။។៕᪨-᪫᭞᭟꧈꧉꩝-꩟꫰꯫𐩖𐩗𑁇𑁈𑃀𑃁𑅁𑅂𑇅𑇆𑈸𑈹𑑋𑑌𑗂𑗃𑙁𑙂𑜼𑜽𑥄𑱁𑱂𑽃𑽄𖩮𖩯᱾᱿؝܀߷჻፠፨᨞᨟᭚᭛᭽᭾꧁-꧆꧊-꧍꛲꥟𐡗𐬺-𐬿𐽕-𐽙𐾆-𐾉𑂾𑂿𑅀𑇈𑇞𑇟𑊩𑜾𑥆𑻷𑻸𑽅-𑽏⁕⁖⁘-⁞⸪-⸭⸽⳼⳿⸙𐤿𐄀-𐄂𐎟𐏐𐤟𒑰-𒑴𒿱𒿲'＇‘-‛׳‹›"＂“-‟⹂〝-〟״«»(（﹙⁽₍︵)）﹚⁾₎︶[［﹇]］﹈{｛﹛︷}｝﹜︸༺-༽᚛᚜⁅⁆⌈-⌋⧼⧽⦃-⦅｟⦆｠⦇-⦘⟅⟆⟦-⟯❨-❵⸂-⸅⸉⸊⸌⸍⸜⸝⸠-⸩⹕-⹜〈〈︿〉〉﹀《︽》︾「﹁｢」﹂｣『﹃』﹄【︻】︼〔﹝︹〕﹞︺〖︗〗︘〘-〛﴾﴿‖⸾⧘-⧛§⸹¶⁋⹍⸿@＠﹫*＊﹡⁎⁑٭꙳/／\\＼﹨⹊&＆﹠⁊⹒#＃﹟%％﹪٪‰؉‱؊†‡⸶-⸸⹋•‣‧⁃⁌⁍′-‴⁗‵-‷〃‸※‿⁔⁀⁐⁁⁂⸀⸁⸆-⸈⸋⸎-⸖⸚⸛⸞⸟⹄-⹈꙾՚՛՟־׀׃׆܊-܍࡞᠀𑙠-𑙬॰꣸-꣺꣼𑬀-𑬉৽੶૰౷಄෴๏๚๛꫞꫟༄-༊࿐࿑་-༒྅࿒-࿔࿙࿚𑨿-𑩆𑪚-𑪜𑪞-𑪢𑱰𑱱᰽-᰿၌-၏៘-៚᪠-᪦᪬᪭᳀-᳇⵰꡴꡵᯼-᯿꤮꧞꧟꩜𐕯𑁉-𑁍𐩐-𐩕𐩘𑱃-𑱅𐬹𐩿𐫰-𐫶𐮙-𐮜𑂻𑂼𑅴𑅵𑇍𑇇𑇛𑇝𑈺-𑈽𑑍𑑚𑑎𑑏𑑛𑑝𑓆𑗁𑗄-𑗗𑙃𑚹𑠻𑥅𑧢𑿿𖬷-𖬻𖭄𖺙𖺚𝪇-𝪋؈𞻰𞻱℘⅁-⅄←￩↚→￫↛↑￪↓￬↠↣↦⇒⇏⇔⇎⇴-∂𝛛𝜕𝝏𝞉𝟃∃-∇𝛁𝛻𝜵𝝯𝞩∈-∍϶∎-∑⅀+＋﬩﹢⁺₊±÷×<＜﹤≮=＝﹦⁼₌≠⩵⩶>＞﹥≯¬￢|｜~～−⁻₋⁒∓-∕⁄∖-∛؆∜؇∝-∭⨌∮-∼≁∽-≀≂-≅≇≆≈-≍≭≎-≟≡-≤≰≥≱≦-≬≲≴≳≵≶≸≷≹≺⊀≻⊁≼⋠≽⋡≾≿⊂⊄⊃⊅⊆⊈⊇⊉-⊑⋢⊒⋣⊓-⊢⊬⊣-⊨⊭⊩⊮⊪⊫⊯-⊲⋪⊳⋫⊴⋬⊵⋭⊶-⊼⅋⊽-⋟⋤-⋩⋮-⋿⌠⌡⍼⎛-⎳⏜-⏡▷◁◸-◺◿⟀-⟄⟇-⟥⟰-⟿⤀-⤳⤶-⦂⦙-⧗⧜-⧻⧾-⨋⨍-⩳⩷-⫛⫝⫝̸⫞-⫿⬰-⭄⭇-⭌♯↔↮⤴⤵‼⁉〰〽◼◻◾◽]`.split("")),M={0:1,"０":1,1:2,"１":2,2:3,"２":3,3:4,"３":4,4:5,"４":5,5:6,"５":6,6:7,"６":7,7:8,"７":8,8:9,"８":9,9:10,"９":10,a:11,ａ:11,Ａ:11,ä:11,b:12,ｂ:12,Ｂ:12,c:13,ｃ:13,Ｃ:13,d:14,ｄ:14,Ｄ:14,e:15,ｅ:15,Ｅ:15,f:16,ｆ:16,Ｆ:16,g:17,ｇ:17,Ｇ:17,h:18,ｈ:18,Ｈ:18,i:19,ｉ:19,Ｉ:19,j:20,ｊ:20,Ｊ:20,k:21,ｋ:21,Ｋ:21,l:22,ｌ:22,Ｌ:22,m:23,ｍ:23,Ｍ:23,n:24,ｎ:24,Ｎ:24,o:25,ｏ:25,Ｏ:25,ö:25,õ:25,p:26,ｐ:26,Ｐ:26,q:27,ｑ:27,Ｑ:27,r:28,ｒ:28,Ｒ:28,s:29,ｓ:29,Ｓ:29,$:29,t:30,ｔ:30,Ｔ:30,u:31,ｕ:31,Ｕ:31,ü:31,v:32,ｖ:32,Ｖ:32,w:33,ｗ:33,Ｗ:33,x:34,ｘ:34,Ｘ:34,y:35,ｙ:35,Ｙ:35,z:36,ｚ:36,Ｚ:36},j=Object.entries(M).reduce((e,[t,o])=>(o in e||(e[o]=[]),e[o].push(t),e),{});function I(e){const t=M[e];return t?j[t]??[e]:[e]}function P(e){return e=e.replace(/[\s・]+/g,"").split("").map(t=>V.has(t)?"":`[${I(t).join("")}]`).join("[\\s\\p{Pc}\\p{Pd}\\p{Pe}\\p{Pf}\\p{Pi}\\p{Po}\\p{Ps}\\p{Sm}]{0,4}"),new RegExp(`(?<!<span class="ame__mark--inner">)${e}`,"gui")}function A(e,t){e.innerHTML=e.innerHTML.replaceAll(t,o=>{const n=document.createElement("span");n.classList.add("ame__mark--inner"),n.innerText=o;const r=document.createElement("span");return r.classList.add("ame__mark"),r.appendChild(n),r.outerHTML})}function T(e){const t=e.value;return e.addEventListener("input",()=>{e.value!==t&&(e.style.backgroundColor="yellow")}),e}function g(e,t){if(e instanceof HTMLInputElement){Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").set.call(e,t),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("focusout",{bubbles:!0}));return}if(e instanceof HTMLSelectElement){Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype,"value").set.call(e,t),e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("focusout",{bubbles:!0}));return}}function N(e,t){const o=w.createOscillator(),n=w.createGain();o.connect(n),n.connect(w.destination),n.gain.value=.25,o.frequency.value=t,o.start(w.currentTime),o.stop(w.currentTime+e/1e3)}var m=(e=>(e.Work="work",e))(m||{});function W(e,t,o=!0){if(document.visibilityState==="visible")return o&&N(50,1e3),t==null?GM.deleteValue(e):(console.info("setBusValue",e,t),GM.setValue(e,{value:t,timestamp:new Date().getTime()+60*1e3}))}async function L(e){if(document.visibilityState!=="visible")return null;const t=await GM.getValue(e);return!t||(await W(e,null,!1),t.timestamp<new Date().getTime())?null:(console.info("getBusValue",e,t),t.value)}async function b(e,t){const o=await L(e);if(o)try{await t(o)}catch(n){console.error(n)}finally{await W(e,o)}}async function D(){_("a[class^='LandingPage_languageButton__']",()=>{location.href="/search"})}async function $(){let e=!1;await b(m.Work,async t=>{if(!t.iswc)return;const o=document.querySelector("#iswc"),n=document.querySelector("button[type='submit']");if(g(o,t.iswc),await l(800),n==null||n.click(),await l(500),e=await Promise.any([k("div[class^='Search_resultsContainer__'] div[class^='AlertMessage_text__']").then(()=>!0),k("[class^='Search_sectionTitle__']").then(i=>!i)]),e)return;const r=document.querySelector("[id='View More']");r.click(),await l(100);const a=h(document,"//button[.='Copy work codes']");a?(a.click(),t.codes.external=!0):r.after(H('<div style="padding: .5rem;">Install <a href="https://musicbrainz.org/doc/Guides/Userscripts#Userscripts:_Works">Bulk copy-paste work codes</a> for better integration.</div>')),t.sources.push(location.href),t.sources=Array.from(new Set(t.sources))}),e&&(location.href="/")}async function z(){return b(m.Work,async e=>{if(!(e!=null&&e.name))return;const t=document.querySelector("input[name='IN_WORKS_TITLE_NAME1']"),o=document.querySelector("button[name='CMD_SEARCH']");t.value!==e.name&&(g(t,e.name),o.click())})}async function F(){return b(m.Work,async e=>{var s,u,f,p;document.querySelector("a[href='#tab-00-07']").click(),await l(300);const o=((u=(s=h(document,"//*[contains(@class, 'baseinfo--iswc')]//strong"))==null?void 0:s.innerText)==null?void 0:u.trim())||null,n=((p=(f=h(document,"//*[contains(@class, 'baseinfo--code')]//strong"))==null?void 0:f.innerText)==null?void 0:p.trim())||null,r=y(document,"//table[contains(@class, 'detail')]//td[contains(., '作詞')]/parent::tr/*[2]").map(E).filter(Boolean).filter(d=>d!=="識別"),a=y(document,"//table[contains(@class, 'detail')]//td[contains(., '作曲')]/parent::tr/*[2]").map(E).filter(Boolean).filter(d=>d!=="識別"),i=y(document,"//table[contains(@class, 'detail')]//td[contains(., '編曲')]/parent::tr/*[2]").map(E).filter(Boolean).filter(d=>d!=="識別"),c=y(document,"//table[contains(@class, 'detail')]//td[contains(., '出版者')]/parent::tr/*[2]").map(E).filter(Boolean).filter(d=>d!=="識別");o&&(e.iswc=o),n&&(e.codes.jasrac=n),e.lyricists=Array.from(new Set(r)),e.composers=Array.from(new Set(a)),e.arrangers=Array.from(new Set(i)),e.publishers=Array.from(new Set(c)),e.sources.push(location.href),e.sources=Array.from(new Set(e.sources))})}function E(e){var t,o;return((o=(t=e.textContent)==null?void 0:t.split(`
`)[0])==null?void 0:o.trim())??""}function G(){const e=document.querySelector(".logo > a");e&&(e.href=`${location.origin}/search`)}function U(){return b(m.Work,async e=>{if(!e.name)return;const t=document.querySelector("#kyokunm"),o=document.querySelector("#search-by-track-and-artist");t.value=e.name,o.click()})}function J(){for(const e of document.querySelectorAll(".saku-detail-link")){const t=document.createElement("a");t.target="_blank",t.href=`/saku/detail/?${e.getAttribute("data-href")}`,t.innerHTML=e.innerHTML,e.replaceWith(t)}return b(m.Work,async e=>{for(const n of e.context.tokens){const r=P(n);for(const a of document.querySelectorAll("#track-list tr td:nth-child(3), #track-list tr td:nth-child(4)"))A(a,r)}if(e.name)for(const n of document.querySelectorAll("#track-list tr td:nth-child(2)"))A(n,P(e.name));const t=document.querySelector("#kyokunm"),o=document.querySelector("#search-by-track-and-artist");!e.name||t.value===e.name||(t.value=e.name,o.click())})}function K(){return b(m.Work,async e=>{var s,u,f,p,d,B;const t=((u=(s=h(document,"//h3/text()[.!='-']"))==null?void 0:s.nodeValue)==null?void 0:u.replaceAll(" ",""))||null,o=((p=(f=h(document,"//a[@href='#jasrac']/following-sibling::*/span[2][.!='']"))==null?void 0:f.innerText)==null?void 0:p.trim())||null,n=((B=(d=h(document,"//a[@href='#nextone']/following-sibling::*/span[2][.!='']"))==null?void 0:d.innerText)==null?void 0:B.trim())||null,r=y(document,"//div[contains(@class, 'management')]//td[contains(., '作詞')]/parent::tr/*[2]").map(S).filter(Boolean),a=y(document,"//div[contains(@class, 'management')]//td[contains(., '作曲')]/parent::tr/*[2]").map(S).filter(Boolean),i=y(document,"//div[contains(@class, 'management')]//td[contains(., '編曲')]/parent::tr/*[2]").map(S).filter(Boolean),c=y(document,"//div[contains(@class, 'management')]//td[contains(., '出版者')]/parent::tr/*[2]").map(S).filter(Boolean);t&&(e.iswc=t),o&&(e.codes.jasrac=o),n&&(e.codes.nextone=n),e.lyricists=Array.from(new Set(r)),e.composers=Array.from(new Set(a)),e.arrangers=Array.from(new Set(i)),e.publishers=Array.from(new Set(c)),e.sources.push(location.href),e.sources=Array.from(new Set(e.sources))})}function S(e){var t,o,n,r;return((r=(n=(o=(t=e.firstChild)==null?void 0:t.textContent)==null?void 0:o.split(`
`)[0])==null?void 0:n.replace(/\s*\/\s*$/,""))==null?void 0:r.trim())??""}let C=!1;function Q(){O(),_("#add-relationship-dialog",async e=>{const t=h(e,"//td[.='Work']/following-sibling::td//button");await l(100),t==null||t.click()})}async function X(){O();const e=T(document.querySelector("#id-edit-work\\.name")),t=T(document.querySelector("input[name='edit-work.iswcs.0']")),o=document.querySelector("#id-edit-work\\.edit_note"),n=await L(m.Work);if(!(n!=null&&n.sources.length)){C||await W(m.Work,{name:e.value||null,iswc:t.value||null,codes:{external:!1,jasrac:null,nextone:null},lyricists:[],composers:[],arrangers:[],publishers:[],sources:[],context:{tokens:Array.from(R(parent===window?document.body:parent.document.body))}});return}if(C=!0,n.iswc&&g(t,n.iswc),n.codes.jasrac&&q("jasrac",n.codes.jasrac),n.codes.nextone&&q("nextone",n.codes.nextone),n.sources.length&&(o.value=`Filled out with Ame (MusicBrainz - Works):
${n.sources.join(`
`)}
`),n.codes.external){const r=document.querySelector("#ROpdebee_MB_Paste_Work");r==null||r.click()}for(const r of n.lyricists)await v("artist","lyrics / lyricist",r);for(const r of n.composers)await v("artist","composed / composer",r);for(const r of n.arrangers)await v("artist","arranged / arranger",r);for(const r of n.publishers)await v("label","published / publisher",r.replace("株式会社","").trim())}function O(){_("ul[id^='relationship-target']",async e=>{new MutationObserver(async o=>{const n=o[0],r=e.style.visibility;if(r==="hidden"||r===n.oldValue)return;const a=e.firstElementChild;if(a!=null&&a.innerText.includes("Click here to try again")){await l(100),a.click();return}const c=document.getElementById(e.getAttribute("aria-labelledby")).control,s=R();c.value&&s.add(c.value);for(const u of s){const f=P(u);for(const p of e.children)A(p,f)}}).observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]})})}function R(e=document.body){return new Set(Array.from(e.querySelectorAll("a[href^='/artist/'][title]")).map(t=>t.innerText.trim()))}async function v(e,t,o){document.querySelector("button.add-relationship").click();const r=await k("#add-relationship-dialog");if(!r)return;const a=r.querySelector("select.entity-type");g(a,e);const i=r.querySelector("input.relationship-type");g(i,t),h(r,`//li[contains(@class, 'option-item') and contains(., '${t}')]`).click();const c=r.querySelector(".relationship-target input");g(c,o),await l(300),r.querySelector(".relationship-target button").click(),await new Promise(u=>{const f=r.querySelector("button.negative"),p=r.querySelector("button.positive");f.addEventListener("click",()=>u()),p.addEventListener("click",()=>u())}),await l(300)}function q(e,t){e=e.toLowerCase();const o=document.querySelector("#add-work-attribute");for(let n=0;n<2;n++){for(const r of document.querySelectorAll("#work-attributes tr:not(:last-child)")){const a=r.querySelector("select"),i=a.selectedOptions[0],c=Array.from(a.options).filter(u=>u.innerText.trim().toLowerCase().startsWith(e))[0];if(i!==c&&i.value)continue;c.selected=!0;const s=T(r.querySelector("input"));s.value=t;return}o.click(),q(e,t)}}GM.addStyle(".ame__mark{background-color:#ff0e!important;outline:2px solid #ffff00ee!important}.ame__mark--inner{color:#000!important;filter:brightness(.1)}");const x=new URLSearchParams(location.search);window.addEventListener("focus",async()=>{var e,t;await l(100),!(!window.document.hasFocus()&&!((e=window.top)!=null&&e.document.hasFocus()))&&(location.host.endsWith("musicbrainz.org")?location.pathname.startsWith("/release/")&&location.pathname.endsWith("/edit-relationships")?await Q():(location.pathname.startsWith("/work/")&&location.pathname.endsWith("/edit")||location.pathname.startsWith("/dialog")&&((t=x.get("path"))!=null&&t.startsWith("/work/create")))&&await X():location.host.endsWith("minc.or.jp")?(await G(),location.pathname.startsWith("/search")?await U():location.pathname.startsWith("/music/list")?await J():location.pathname.startsWith("/saku/detail")&&await K()):location.host.endsWith("cisac.org")?(await D(),location.pathname.startsWith("/search")&&await $()):location.host.endsWith("jasrac.or.jp")&&(x.get("trxID")==="F00100"?await z():x.get("trxID")==="F20101"&&await F()))}),window.dispatchEvent(new Event("focus"))});
